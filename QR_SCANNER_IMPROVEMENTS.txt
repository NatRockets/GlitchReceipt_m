=== QR SCANNER - ИСПРАВЛЕННЫЙ АЛГОРИТМ ===

ПРОБЛЕМЫ КОТОРЫЕ БЫЛИ ИСПРАВЛЕНЫ:

1. МНОЖЕСТВЕННОЕ СРАБАТЫВАНИЕ
   - Добавлен флаг _isProcessingQR для блокировки повторного срабатывания
   - Callback handleBarcode синхронная, не async
   - Реальные async операции отложены в отдельные методы

2. УПРАВЛЕНИЕ КАМЕРОЙ
   - Камера останавливается сразу при обнаружении кода (controller.stop())
   - Задержка 300мс перед возобновлением после диалогов
   - Правильная обработка ошибок при stop/start

3. ОБРАБОТКА РАЗРЕШЕНИЙ
   - Нативный iOS диалог с текстом из Info.plist (NSCameraUsageDescription)
   - Проверка статуса разрешения перед запуском камеры
   - Диалог настроек если разрешение постоянно запрещено

4. ОБРАБОТКА ОШИБОК
   - errorBuilder в MobileScanner для отображения ошибок камеры
   - try-catch при запуске и остановке камеры
   - Вывод информативных сообщений об ошибках

ПОЛНЫЙ ПОТОК ВЫПОЛНЕНИЯ:

1. User нажимает "Start Scanning"
   ↓
2. Воспроизводится звук (feedback.selectionClick)
   ↓
3. Проверяется статус разрешения
   → Если не дано: показывается iOS система диалог запроса
   ↓
4. Запускается камера (controller.start)
   → После 300мс задержки: UI переходит в режим сканирования
   ↓
5. MobileScanner обнаруживает QR-код
   → _handleBarcode вызывается (синхронно)
   ↓
6. Проверяется _isProcessingQR флаг
   → Если уже обрабатывается: игнорируется
   ↓
7. Валидируется сумма из QR-кода
   ✓ Валидна:
     - Устанавливается _isProcessingQR = true
     - Вызывается _processValidQRCode (async)
     - Камера стопится
     - Показывается диалог заметок
     ↓
     User вводит заметку:
     - Сохранить: сохраняется рецепт → диалог подтверждения → остановка
     - Отменить: возобновляется сканирование через _resumeScanning
   
   ✗ Невалидна:
     - Устанавливается _isProcessingQR = true
     - Вызывается _showInvalidAmountDialog (async)
     - Камера стопится
     - Показывается диалог ошибки
     ↓
     User нажимает OK:
     - Возобновляется сканирование через _resumeScanning

ВАЖНЫЕ МЕТОДЫ:

_requestCameraPermission() → bool
- Проверяет текущий статус разрешения
- Если не дано: показывает нативный iOS диалог
- Возвращает был ли доступ разрешен

_handleBarcode(BarcodeCapture) → void (синхронный)
- Основной callback от MobileScanner
- Запускает async операции без ожидания

_processValidQRCode(String) → Future
- Останавливает камеру
- Показывает диалог заметок

_showInvalidAmountDialog() → Future
- Останавливает камеру
- Показывает диалог ошибки

_resumeScanning() → Future
- Задержка 300мс
- Перезапускает камеру
- Сбрасывает _isProcessingQR флаг

СОСТОЯНИЯ СКАННЕРА:

_isScanning: true
- Показывается MobileScanner виджет с превью
- Доступна кнопка "Stop Scanning"

_isScanning: false
- Показывается главный экран с кнопками
- "Start Scanning" и "Enter Amount Manually"

_isProcessingQR: true
- Блокирует повторную обработку QR-кодов
- Сбрасывается после возобновления сканирования

INFO.PLIST КОНФИГУРАЦИЯ (iOS):

NSCameraUsageDescription:
"This app needs access to your camera to scan QR codes"
→ Это текст, который видит пользователь в системном диалоге

NSMicrophoneUsageDescription:
"Microphone permission is required for camera access to be processed correctly..."
→ Требуется для некоторых устройств iOS
